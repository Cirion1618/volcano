<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Volcano Hybrid Test Control</title>
  <style>
    #log {
      max-height: 200px;
      overflow-y: auto;
      background: #f0f0f0;
      padding: 1em;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>Volcano Hybrid - Advanced Control Panel</h2>
  <button onclick="connect()">üîó Connect to Volcano</button>
  <button onclick="runWorkflowX()">üöÄ Start Custom Workflow X</button>
  <button onclick="abortWorkflow()">‚õî Abort Workflow</button>
  <p id="status">Status: Not connected</p>
  <p>Current Temperature: <span id="currentTemp">-</span>¬∞C</p>
  <p>Heater Status: <span id="heaterStatus">Unknown</span></p>
  <p>Pump Status: <span id="pumpStatus">Unknown</span></p>
  <div id="log"></div>

  <script>
    let server, service;
    let abortFlag = false;
    const serviceUUID = '10110000-5354-4f52-5a26-4249434b454c';

    const workflowX_temperature = [175, 180, 185, 190, 195];
    const workflowX_holdTimeInMilliSeconds = [7000, 7000, 0, 0, 0];
    const workflowX_pumpTimeInMilliSeconds = [7000, 7000, 7000, 7000, 10000];

    function log(msg) {
      const el = document.getElementById("log");
      el.innerText += msg + "\n";
      el.scrollTop = el.scrollHeight;
    }

    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [serviceUUID]
        });

        document.getElementById("status").innerText = `Status: Connecting to ${device.name}...`;

        server = await device.gatt.connect();
        service = await server.getPrimaryService(serviceUUID);

        document.getElementById("status").innerText = `Status: Connected to ${device.name}`;
        log("Connected to device: " + device.name);

        setInterval(updateStatuses, 3000);

      } catch (err) {
        document.getElementById("status").innerText = `Connection failed: ${err.message}`;
        log("Connection error: " + err);
      }
    }

    async function runWorkflowX() {
      abortFlag = false;
      for (let i = 0; i < workflowX_temperature.length; i++) {
        if (abortFlag) {
          log("üö´ Workflow aborted");
          return;
        }
        const targetTemp = workflowX_temperature[i] * 10;
        await setTemperature(targetTemp);
        await startHeater();
        await waitForTemp(targetTemp);
        if (abortFlag) break;
        await hold(workflowX_holdTimeInMilliSeconds[i]);
        if (abortFlag) break;
        await startPump(workflowX_pumpTimeInMilliSeconds[i]);
      }
      await stopHeater();
      log("‚úÖ Workflow X completed or aborted");
    }

    function abortWorkflow() {
      abortFlag = true;
    }

    async function setTemperature(tempInTenthDegrees) {
      const char = await service.getCharacteristic('10110003-5354-4f52-5a26-4249434b454c');
      const buffer = new ArrayBuffer(2);
      new DataView(buffer).setUint16(0, tempInTenthDegrees, true);
      await char.writeValue(buffer);
      log(`üå°Ô∏è Set temperature to ${tempInTenthDegrees / 10}¬∞C`);
    }

    async function startHeater() {
      const char = await service.getCharacteristic('1011000f-5354-4f52-5a26-4249434b454c');
      await char.writeValue(new Uint8Array([0x01]));
      document.getElementById("heaterStatus").innerText = "ON";
      log("üî• Heater started");
    }

    async function stopHeater() {
      const char = await service.getCharacteristic('10110010-5354-4f52-5a26-4249434b454c');
      await char.writeValue(new Uint8Array([0x01]));
      document.getElementById("heaterStatus").innerText = "OFF";
      log("üõë Heater stopped");
    }

    async function waitForTemp(targetTemp) {
      const char = await service.getCharacteristic('10110001-5354-4f52-5a26-4249434b454c');
      let temp = 0;
      while (Math.abs(temp - targetTemp) > 10) {
        if (abortFlag) return;
        const value = await char.readValue();
        temp = new DataView(value.buffer).getUint16(0, true);
        document.getElementById("currentTemp").innerText = (temp / 10).toFixed(1);
        log(`Current temperature: ${temp / 10}¬∞C`);
        await new Promise(r => setTimeout(r, 1500));
      }
      log("‚úÖ Temperature reached");
    }

    async function hold(ms) {
      log(`‚è≥ Holding for ${ms}ms`);
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function startPump(duration) {
      const char = await service.getCharacteristic('10110013-5354-4f52-5a26-4249434b454c');
      await char.writeValue(new Uint8Array([0x01]));
      document.getElementById("pumpStatus").innerText = "ON";
      log("üí® Pump started");
      await new Promise(resolve => setTimeout(resolve, duration));
      await char.writeValue(new Uint8Array([0x00]));
      document.getElementById("pumpStatus").innerText = "OFF";
      log("üõë Pump stopped");
    }

    async function updateStatuses() {
      try {
        const heatChar = await service.getCharacteristic('1011000f-5354-4f52-5a26-4249434b454c');
        const pumpChar = await service.getCharacteristic('10110013-5354-4f52-5a26-4249434b454c');

        const heaterValue = await heatChar.readValue();
        const heaterStatus = heaterValue.getUint8(0) === 1 ? "ON" : "OFF";
        document.getElementById("heaterStatus").innerText = heaterStatus;

      } catch (err) {
        log("‚ö†Ô∏è Error updating statuses: " + err);
      }
    }
  </script>
</body>
</html>
